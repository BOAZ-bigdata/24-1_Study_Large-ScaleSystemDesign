# 8장 URL 단축기 설계
## 1단계 문제 이해 및 설계 범위 확정
**개략적 추정**
- 쓰기 연산 : 매일 1억개의 단축 URL생성
- 초당 쓰기 연산 : 1억/24/3600= 1160
- 읽기 연산 : 쓰기 연산의 10배라고 가정 -> 11600회
- URL 단축 서비스를 10년간 이용 : 1억 * 365 * 10 -> 3650억개의 레코드 보관
- 축약 전 URL 평균 길이 100
- 10년 동안 필요한 저장 용량 : 3650억*100바이트 = 36.5 TB

## 2단계 개략적 설계안 제시 및 동의 구하기
### API 엔드포인트
- 클라이언트는 서버가 제공하는 API엔드포인트를 이용해서 서버와 통신
- URL 단축용 엔드포인트: 새 단축 URL을 만들기 위해서는 클라이언트에 URL을 인자로 실어서 POST요청을 해야함 **EX) POST/api/v1/data/shorten**
- URL 리디렉션용 엔드포인트: 단축 URL에 대해 HTTP요청이 오면 원래 URL로 보내주기 위한 용도 **EX) GET/api/v1/shortUrl**

### URL 리디렉션
- 301응답: 브라우저가 응답을 캐시해서 추후 같은 URL에 요청을 보낼 떄 이를 사용한다 -> 서버 부하를 줄이기 위해서 사용
- 302: 언제나 URL서버에 보내진 후 원래 URL로 리디렉션 되야한다. -> 트래픽 분석이 중요할 때 사용 

### URL 단축 (URL을 해시 값으로 대응)
- 입력으로 주어지는 URL이 다른 값이면 해시 값도 달라야 함
- 계산된 해시 값은 원래 입력으로 주어졌던 URL로 복원될 수 있어야 한다.

## 3단계 상세 설계 
### 데이터 모델
- 개략적 설계에서는 모든 것을 해시에 두었다.
- 실제 서비스에서는 쓰시가 곤란 
- 더 나은 방법으로 <단축 URL, 원래 URL>을 관계형 DB에 저장하는 방법이 있다.
### 해시 함수
- 원래 URL을 단축 URL로 변환하는 함수.
- 해시 함수가 계산하는 단축 URL 값을 hashValue라고 지칭, hashValue는 [0-9, a-z, A-Z]의 문자들로 구성. ⇒ 총 62개
- hashValue의 길이를 정하기 위해 62^n>=3650억에 해당되는 n을 찾아야 함.
- N이 7일 경우 요구사항을 만족함

### 해시 후 충돌 해소
- CRC32, MD5, SHA-1의 방법이 있다. 

|해시 함수	해시 결과 |(16진수)|
|-----|--------|
|CRC32|5cb54054|
|MD5|5a62509a84df9ee03fe1230b9df8b84e|
|SHA-1|0eeae7916c06853901d9ccbefbfcaf4de56ed85b|

**CRC32를 사용해도 7보다는 큰 문제가 있다. -> 해시 결과가 충돌할 가능성 있음**
![img](https://github.com/sangminlee98/system-design-interview/assets/83197138/21e60f25-0a05-41ef-8384-ebe03f2fb5b0)
이 방법으로 해결 가능 하지만 한 번 이상 DB질의를 해야 함으로 오버헤드가 크다

### base-62 변환
- URL 단축기를 구현할 때 흔히 사용되는 접근법
- 62진법을 사용

|해시 후 충돌 해소 전략|base-62 변환|
|---|---|
|단축 URL의 길이가 고정됨|단축 URL의 길이가 가변적. ID값이 커지면 같이 길어짐
|유일성이 보장되는 ID 생성기가 필요치 않음|유일성 보장 ID 생성기가 필요
|충돌이 가능해서 해소 전략이 필요|ID의 유일성이 보장된 후에야 적용 가능한 전략이라 충돌은 아예 불가능|
|ID로부터 단축 URL을 계산하는 방식이 아니라서 다음에 쓸 수 있는 URL을 알아내는 것이 불가능|ID가 1씩 증가하는 값이라고 가정하면 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 알아낼 수 있어서 보안상 문제가 될 소지가 있음|
### 처리 흐림 순서도
![img](https://github.com/sangminlee98/system-design-interview/assets/83197138/8224a57a-6655-46eb-a06b-3b6b02146e2c)
### URL 리디렉션 상세 설계
![img](https://github.com/sangminlee98/system-design-interview/assets/83197138/12c7f7ab-a3c4-4922-8077-3d4d478888ab)
**로드밸런서의 동작 흐름**
- 사용자가 단축 URL을 클릭한다.
- 로드밸런서가 해당 클릭으로 발생한 요청을 웹 서버에 전달한다.
- 단축 URL이 이미 캐시에 있는 경우에는 원래 URL을 바로 꺼내서 클라이언트에게 전달한다.
- 캐시에 해당 단축 URL이 없는 경우에는 데이터베이스에서 꺼낸다. 데이터베이스에 없다면 아마 사용자가 잘못된 단축 URL을 입력한 경우일 것이다.
- 데이터베이스 꺼낸 URL을 캐시에 넣은 후 사용자에게 반환한다.

## 4단계 마무리
**시간이 남으면 생각해 볼 것**
- 처리율 제한 장치
- 웹 서버 규모 확장
- 데이터베이스 규모 확장
- 데이터 분석 솔루션
- 가용성, 데이터 일관성, 안정성
