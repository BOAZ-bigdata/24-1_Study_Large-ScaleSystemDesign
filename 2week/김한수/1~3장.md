# 1~3장

- [1~3장](#13장)
- [1. 사용자 수에 따른 규모 확장성](#1-사용자-수에-따른-규모-확장성)
  - [로드밸런서를 통한 수평적 규모 확장](#로드밸런서를-통한-수평적-규모-확장)
  - [데이터베이스 다중화](#데이터베이스-다중화)
  - [캐시](#캐시)
  - [CDN(Content Delivery Network)](#cdncontent-delivery-network)
  - [무상태(stateless) 웹 계층](#무상태stateless-웹-계층)
  - [데이터 센터](#데이터-센터)
  - [메시지 큐](#메시지-큐)
  - [로그, 메트릭, 자동화](#로그-메트릭-자동화)
  - [데이터베이스의 규모 확장](#데이터베이스의-규모-확장)
  - [백만 사용자를 대비한 아키텍처 포인트](#백만-사용자를-대비한-아키텍처-포인트)
- [2. 개략적인 규모 측정](#2-개략적인-규모-측정)
  - [고가용성에 대한 지표](#고가용성에-대한-지표)
  - [QPS(Query Per Second) 추정하기](#qpsquery-per-second-추정하기)
- [3. 시스템 설계 면접 공략법](#3-시스템-설계-면접-공략법)
  - [효과적인 면접을 위한 4단계 접근법](#효과적인-면접을-위한-4단계-접근법)
  - [TIP](#tip)

# 1. 사용자 수에 따른 규모 확장성

단일 서버에서 사용자 수가 늘어날 수록 어떻게 아키텍처를 확장하는 지에 대해 다룬다.

## 로드밸런서를 통한 수평적 규모 확장

- 로드밸러서를 통해서 각 인스턴스의 장애에 대응하여 가용성을 높임

## 데이터베이스 다중화

- master-slave구조로 쓰기 연산, 조회 읽기 연산 분리

## 캐시

- 서버와 데이터베이스 사이 캐시 계층을 통한 성능 향상
- **캐시 사용 시 주의할 점**
  - 데이터 갱신이 자주 일어나지 않고 조회는 빈번하게 일어나는지?
  - 중요한 데이터인지? 휘발되어도 괜찮은지?
  - 만료되어야 하는지? 캐시 만료 정책을 잘 지정해야함
  - 데이터 저장소의 원본과 캐시 내의 사본의 일관성이 중요한지?
  - SPOF(Single Point Of Failure)가 되지 않게 캐시 서버도 분산해야함
  - 캐시 메모리는 얼마나 크게 잡을 것인지? 캐시 방출(eviction) 대응
  - eviction 정책은 어떠헥 할 것인지? LRU, FIFO 등

## CDN(Content Delivery Network)

- CDN을 통해 지리적으로 가까운 곳의 서버에 캐시를 두고 글로벌 서비스의 네트워크 흐름을 최적화
- 요청 경로, query string, 쿠키, request header 등의 정보에 기반하여 html 페이지를 캐시
- CDN service로는 아카마이, Amazon CloudFront 등이 있음
- **CDN 사용 시 고려사항**
  - 비용
    - CDN은 보통 서드파티 서비스를 사용해야 하며 데이터 전송량을 기준으로 비용을 지불하기 때문에 트레이드오프를 잘 고려해야함
    - 만료 기간 설정을 적절하게 해야함
    - CDN 장애 발생 시 해당 장애를 감지하고 원본 서버에서 데이터를 조회할 수 있게 장애 복구 대응을 해야할 수도 있음
    - 컨텐츠 무효화 방법도 요구사항에 따라 고려해야 함

## 무상태(stateless) 웹 계층

- 웹 계층을 수평적으로 확장하기 위해 stateless로 만드는 방법에 대한 이야기
  - 세션 등 상태값을 서버에서 가지지 않도록하는 것이 핵심
  - stateless이면 각 계층 확장을 비교적 자유롭게 할 수 있음

## 데이터 센터

- 물리적인 데이터 센터가 자연 재해로 인해 장애가 발생할 수 있으므로 데이터 센터의 다중화도 필요할 수 있음
- 물리적으로 데이터 센터가 분리되면 데이터 싱크에 대해서도 도전과제들이 생김

## 메시지 큐

- 메시지 큐는 데이터의 무손실을 보장하면서 비동기 통신을 지원하는 컴포넌트
- 메시지의 버퍼 역할을 하고, 비동기로 전송하는 구조
- 메시지 큐 구조에는 메시지를 생산하는 `생산자`(producer or publisher)와 `소비자` 혹은 구독자(consumer or subscriber)라고 불리는 역할이 존재하게 됨
- **메시지 큐를 사용하면 서비스 간의 결합이 느슨해져서 규모 확장성이 좋아짐.**

## 로그, 메트릭, 자동화

- 소규모 서비스일 때는 로그, 메트릭 등의 가시성 확보와 자동화는 꼭 필요하지 않을 수 있지만 서비스의 규모가 커지면 이런 부분들이 매우 중요해짐
  - `로그`
    - 시스템의 오류와 문제들을 쉽게 발견하게 해주므로 중요함
    - 로그를 단일 서비스로 모아주는 도구를 활용하면 더 편리하게 검색하고 조회할 수 있음
      - e.g. ELK 스택
  - `메트릭`
    - 메트릭을 잘 활용하면 사업 현황에 대한 유용한 정보와 시스템의 현재 상태를 손쉽게 파악할 수 있음
    - e.g.
      - APM(CPU, 메모리 등의 모니터링)
      - active user 수
  - `자동화`
    - CI/CD와 같은 개발, 운영 최적화

## 데이터베이스의 규모 확장

- 수직적 확장
  - SOPF가 될 확률이 높아 위험함
  - 비용이 많이 듬
- 수평적 확장
  - 샤딩(sharding)이라고도 부르며 여러 서버를 추가하는 방식
- `샤딩`
  - 샤드라는 물리적 저장소 단위로 데이터를 나누는 `샤딩`은 보통 샤드의 수로 나눈 나머지 값 등 일정 계산 식을 통해 데이터를 분배함. 이렇게 나누는 기준 값을 파티션 키라고도 함
    - e.g. 샤드가 4개라면 4로 나눈 나머지 값에 의해 데이터가 위치할 샤드를 지정
  - `샤딩의 문제점`
    - 데이터 재 샤딩(resharding)
      - 데이터가 너무 많아져서 샤드를 더 추가하고 싶다면 데이터 재배치 과정을 거쳐야함
    - 유명인사 문제(=핫스팟 키 문제)
      - 일정 샤드에 유명인사가 있어서 부하가 몰리는 현상
    - 조인과 비정규화
      - 샤드 서버로 데이터를 쪼개면 여러 샤드에 걸친 데이터를 조인하기 힘듬
      - 이를 해결하는 방법으로 데이터베이스를 비정규화 하고 하나의 테이블에서 질의가 수행될 수 있도록 하는 방법이 있음

## 백만 사용자를 대비한 아키텍처 포인트

- 다음 포인트들을 기억하고 백만 사용자를 대비한 아키텍처를 만들어보자
  - 웹 계층은 stateless 계층으로
  - 모든 계층에 다중화 도입
  - 가능한 한 많은 데이터 캐싱을 통한 성능 개선
  - 다중 데이터 센터 지원
  - 정적 컨텐츠를 CDN을 통해 서비스해서 성능 개선
  - 데이터 계층 샤딩을 통한 규모 확장
  - 각 계층을 독립적인 서비스로 분할 (확장에 대한 의존성 제거)
  - 시스템을 지속적으로 모니터링하고, 자동화 도구(CI,CD)들을 활용
    (옵저버빌리티 확보 및 개발, 운영 최적화)

# 2. 개략적인 규모 측정

데이터 규모를 예측하는 방법에 대해서 다룸

## 고가용성에 대한 지표

- SLA(Service Level Agreement)
  - 서비스 사업자가 보편적으로 사용하는 용어로 서비스 사업자와 고객 사이에 맺어진 가용시간 합의를 뜻함 → 가용률 지표
  - 아마존, 구글 그리고 MS 같은 사업자는 99% 이상의 SLA를 제공

## QPS(Query Per Second) 추정하기

- 일간 능동 사용자 + 액션 수 등을 지정해서 개략적으로 규모를 측정해볼 수 있음

# 3. 시스템 설계 면접 공략법

## 효과적인 면접을 위한 4단계 접근법

1. 문제 이해 및 설계 범위 확정
    - 면접관과의 소통을 통해 문제를 정확히 이해하고 설계 범위를 확정한다.
    - 올바른 질문, 적절한 가정 그리고 시스템 구축에 필요한 정보를 모으는 것이 중요
    - 서로 소통하는 것이 중요하다. 문제 풀이가 아니라 면접이다.
2. 개략적인 설계안 제시 및 동의 구하기
    - 설계안에 대해서 면접관과 소통하며 의견을 구하라. 훌륭한 면접관들은 지원자들과 대화하고 설계 과정에 개입하기를 즐긴다.
3. 상세 설계
    - 시스템의 상세 설계를 진행하라.
    - 선임급 개발자 면접이라면 시스템의 성능 특성에 대한 질문을 던질 것이고 이런 세부사항을 깊이 있게 설명하는 걸 보길 원할 것이다.
    - 면접관에게 긍정적 신호를 전달하는 데 집중해야 한다. 불필요한 세부사항에 시간을 쓰지 말아라.
4. 마무리
    - 마지막 단계에서는 설계 결과물에 관련된 후속 질문이 있거나 면접자 스스로 추가 논의를 진행하도록 할 수도 있다.
    - 개선할 점은 언제나 있게 마련이고 그런 질문들을 받는다면 비판적 사고 능력을 보여 좋은 인상을 남겨라

## TIP

- **이런 건 해라**
  - 질문을 통해 확인하고 스스로 내린 가정이 옳다 믿고 진행하지 마라
  - 문제의 요구사항을 이해하라
  - 정답은 없다
  - 면접자의 사고흐름을 면접관이 이해할 수 있게하라
  - 가능하다면 여러 해법을 함께 제시하라
  - 개략적 설계에 협의가 되었다면 가장 중요한 컴포넌트부터 진행하라
  - 면접관의 아이디어를 이끌어 내라. 좋은 면접관은 여러분과 같은 팀원처럼 협업한다.
  - 포기하지 마라
- **이런 건 하지마라**
  - 전형적인 면접 문제들을 대비하지 않은 상태에서 면접장에 가지 마라
  - 요구사항이나 가정들을 분명히 하지 않은 상태에서 설계를 제시하지 마라
  - 처음부터 특정 컴포넌트의 세부사항을 너무 깊이 설명하지 마라. 개략적 설계를 마친 뒤에 세부사항으로 넘어가라
  - 진행 중에 막혔다면 도움을 구하는 걸 주저하지 말라
  - 소통을 주저하지 말고 침묵 속에서 설계를 진행하지 마라
  - 설계안을 내놓는 순간 면접이 끝난 건 아니다. 면접관이 끝났다고 말하기 전까지 끝난 게 아니다. 의견을 일찍 그리고 자주 구하라
- **시간 배분도 적절하게 하라**
- 결국은 소통이 중요하다.
  - 면접관 입장에서 면접은 같이 일할 사람을 뽑는 자리이고 같이 일하고 싶은 사람이라는 좋은 시그널을 주는 것이 중요하다.
